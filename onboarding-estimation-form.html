<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
  <meta charset="UTF-8">
  <title>Implementation & License Estimation</title>
  <link rel="icon" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggZmlsbC1ydWxlPSJldmVub2RkIiBjbGlwLXJ1bGU9ImV2ZW5vZGQiIGQ9Ik00LjE1OTUgMTMuNjM2NEw4Ljc5NTc3IDkuNDUyODZDOS4wNjAwNCA5LjIxNDQ0IDkuMzQ0NzIgOS4wMjg1NyA5LjY0MDYyIDkuMDI4NTdIOS42NTM5OEM5LjkzNjE0IDkuMDM0ODUgMTAuMjA0NyA5LjIwOTI2IDEwLjQ2MzIgOS40NDcyTDExLjk4OTUgMTkuNjM2NEg3LjE5NDc1QzYuMzY3OTYgMTkuNjM2NCA1LjU3NjY2IDE5LjMwNzMgNS4wMzA2NCAxOC43MzdMNC4wMjI4MyAxNy42ODU4QzMuMDc2NzUgMTYuNjk4NiAzLjEzNTk4IDE1LjE0MTMgNC4xNTk1IDEzLjYzNjRWTTEzLjUzNjggNC4zNjM2NEw4LjkwMDUxIDguNTQ3MTRDOC42MzYyMyA4Ljc4NTU2IDguMzUxNTUgOC45NzE0MyA4LjA1NTY1IDguOTcxNDNIODuMDQyMjlDNy43NjAxMiA4Ljk2NTE1IDcuNDkxNTcgOC43OTA3NCA3LjIzMzE0IDguNTUyOEw1LjcwNjg0IDAuMzYzNjM2SDE2LjgwNTJDMjEuMTk0MSAwLjM2MzYzNiAyNC41NzM1IDQuMzQyMDUgMjMuNzY2NyA4LjY0OTg2QzIzLjY0NzkgOS4yODQzMyAyMy40ODUzIDkuODU0NCAyMy4yNzc1IDEwLjM2MzZIMTMuNTM2OFY0LjM2MzY0Wk0xNS45ODk1IDE5LjYzNjRMMTEuMzUzMyAxNS40NTI5QzExLjA4OSAxNS4yMTQ0IDEwLjgwNDMgMTUuMDI4NiAxMC41MDgzIDE1LjAyODZIMTAuNDk1QzEwLjIxMjggMTUuMDM0OCA5Ljk0NDI4IDE1LjIwOTMgOS42ODU3NCAxNS40NDcyTDguMTU5NTEgMTkuNjM2NEgxNS45ODk1WiIgZmlsbD0iIzAwNTJDQyIvPgo8L3N2Zz4=">
  <style>
    :root {
      /* --- Light Mode Tokens --- */
      --ds-surface: #FFFFFF;
      --ds-surface-sunken: #F7F8F9;
      --ds-background-input: #F4F5F7;
      --ds-background-input-hovered: #EBECF0;
      --ds-text: #172B4D;
      --ds-text-subtle: #626F86;
      --ds-link: #0C66E4;
      --ds-border: #DCDFE4;
      --ds-border-focused: #388BFF;
      --ds-background-brand-bold: #0C66E4;
      --ds-background-brand-bold-hovered: #0055CC;
      --ds-background-success-bold: #36B37E;
      --ds-background-danger-bold: #CA3521;
      --ds-shadow-card: 0px 1px 1px rgba(9, 30, 66, 0.25), 0px 0px 1px 1px rgba(9, 30, 66, 0.13);
      --sidebar-width: 320px;
    }

    [data-theme="dark"] {
      --ds-surface: #22272B;
      --ds-surface-sunken: #1D2125;
      --ds-background-input: #22272B;
      --ds-background-input-hovered: #2C333A;
      --ds-text: #B6C2CF;
      --ds-text-subtle: #8C9BAB;
      --ds-link: #579DFF;
      --ds-border: #454F59;
      --ds-border-focused: #579DFF;
      --ds-background-brand-bold: #579DFF;
      --ds-background-brand-bold-hovered: #85B8FF;
      --ds-background-success-bold: #216E4E;
      --ds-background-danger-bold: #AE2A19;
      --ds-shadow-card: 0px 1px 1px rgba(0, 0, 0, 0.5), 0px 0px 1px 1px rgba(0, 0, 0, 0.5);
    }

    * { box-sizing: border-box; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Roboto", sans-serif;
      background-color: var(--ds-surface-sunken);
      color: var(--ds-text);
      margin: 0;
      padding: 0;
      line-height: 1.5;
      transition: background-color 0.3s, color 0.3s;
    }

    /* --- Header --- */
    header {
      background: var(--ds-surface);
      padding: 20px 40px;
      border-bottom: 1px solid var(--ds-border);
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: 0 2px 4px rgba(0,0,0,0.02);
    }

    .header-content {
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      justify-content: space-between;
      align-items: flex-end;
    }

    .header-left-group {
      display: flex;
      align-items: center; 
      gap: 12px;
    }

    /* FIXED: Using IMG tag for logo */
    .atlassian-logo {
      width: 32px;
      height: 32px;
      object-fit: contain; /* Ensures the PNG fits nicely */
      flex-shrink: 0;
      display: block;
    }

    .header-titles h1 {
      margin: 0;
      font-size: 24px;
      font-weight: 500;
      color: var(--ds-text);
      line-height: 1.2;
    }

    .header-actions { display: flex; align-items: flex-end; gap: 20px; }

    .theme-toggle-btn {
      background: transparent;
      border: 1px solid var(--ds-border);
      color: var(--ds-text);
      width: 36px; height: 36px;
      border-radius: 50%;
      cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      font-size: 18px;
    }
    .theme-toggle-btn:hover { background: var(--ds-background-input-hovered); }

    .client-input-group { display: flex; flex-direction: column; align-items: flex-end; gap: 4px; }
    .client-input-group label { font-size: 11px; text-transform: uppercase; font-weight: 700; color: var(--ds-text-subtle); }

    .client-name-input {
      font-size: 18px; padding: 4px 8px; border: 1px solid transparent; background: transparent; border-radius: 3px; color: var(--ds-text); font-weight: 500; text-align: right; width: 300px; transition: all 0.2s;
    }
    .client-name-input:hover { background: var(--ds-background-input); }
    .client-name-input:focus { background: var(--ds-surface); border-color: var(--ds-border-focused); outline: none; }

    /* --- Layout --- */
    .app-container {
      max-width: 1200px;
      margin: 40px auto;
      padding: 0 40px 80px;
      display: grid;
      grid-template-columns: 1fr var(--sidebar-width);
      gap: 32px;
      align-items: start;
    }

    @media (max-width: 960px) {
      .app-container { grid-template-columns: 1fr; padding: 20px; }
      header { position: static; }
      .header-content { flex-direction: column; align-items: flex-start; gap: 16px; }
      .header-actions { width: 100%; justify-content: space-between; align-items: center; }
      .client-input-group { align-items: flex-start; width: 100%; }
      .client-name-input { text-align: left; width: 100%; }
    }

    /* --- Phase Headers --- */
    .phase-header {
      font-size: 12px; font-weight: 700; text-transform: uppercase; color: var(--ds-text-subtle); margin: 32px 0 12px 0; padding-bottom: 8px; border-bottom: 2px solid var(--ds-border); display: flex; align-items: center; gap: 8px;
    }
    .phase-header:first-of-type { margin-top: 0; }
    .phase-badge { background: var(--ds-border); color: var(--ds-text); padding: 2px 6px; border-radius: 3px; }

    /* --- Cards --- */
    .sections-wrapper { display: flex; flex-direction: column; gap: 16px; }

    .section-card {
      background: var(--ds-surface); border-radius: 3px; box-shadow: var(--ds-shadow-card); transition: background-color 0.3s, box-shadow 0.2s; border: 1px solid transparent;
    }
    [data-theme="dark"] .section-card { border: 1px solid var(--ds-border); }
    .section-card:hover { box-shadow: 0px 4px 8px rgba(0,0,0,0.2); }

    .section-disabled { opacity: 0.5; background-color: var(--ds-surface-sunken); box-shadow: none; border: 1px solid var(--ds-border); }

    .section-header { padding: 16px 24px; border-bottom: 1px solid var(--ds-border); display: flex; justify-content: space-between; align-items: center; }
    .header-left { display: flex; align-items: center; gap: 12px; }
    
    .section-badge { background: var(--ds-text); color: var(--ds-surface); font-size: 12px; font-weight: 700; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; border-radius: 50%; }
    [data-theme="dark"] .section-badge { background: var(--ds-text); color: var(--ds-surface-sunken); }

    .section-title { font-size: 16px; font-weight: 600; color: var(--ds-text); }
    .section-body { padding: 20px 24px; }
    .section-body-disabled { pointer-events: none; filter: grayscale(1); }

    /* --- Tasks --- */
    .tasks-list { list-style: none; padding: 0; margin: 0 0 24px 0; }
    .task-item { display: flex; align-items: flex-start; gap: 10px; margin-bottom: 8px; font-size: 14px; color: var(--ds-text); }
    .task-item.excluded { text-decoration: line-through; color: var(--ds-text-subtle); }

    input[type="checkbox"] {
      appearance: none; width: 16px; height: 16px; border: 2px solid var(--ds-border); background: var(--ds-background-input); border-radius: 3px; margin-top: 3px; cursor: pointer; flex-shrink: 0;
    }
    input[type="checkbox"]:checked { background: var(--ds-background-brand-bold); border-color: var(--ds-background-brand-bold); }
    input[type="checkbox"]:checked::after { content: ''; position: absolute; margin: 1px 0 0 4px; width: 4px; height: 8px; border: solid var(--ds-surface); border-width: 0 2px 2px 0; transform: rotate(45deg); }

    /* --- License Table --- */
    .license-table { width: 100%; border-collapse: collapse; font-size: 13px; margin-bottom: 16px; }
    .license-table th { text-align: left; font-size: 11px; font-weight: 700; text-transform: uppercase; color: var(--ds-text-subtle); border-bottom: 2px solid var(--ds-border); padding: 8px 4px; }
    .license-table td { padding: 8px 4px; border-bottom: 1px solid var(--ds-border); vertical-align: top; color: var(--ds-text); }

    .license-input, .license-select { width: 100%; padding: 6px 8px; border: 1px solid var(--ds-border); background: var(--ds-background-input); color: var(--ds-text); border-radius: 3px; font-family: inherit; font-size: 13px; }
    .license-input:focus, .license-select:focus { background: var(--ds-surface); border-color: var(--ds-border-focused); outline: none; }

    .row-total-cell { font-weight: 600; text-align: right; padding-top: 14px; color: var(--ds-text); }

    .btn-add-row { background: transparent; color: var(--ds-background-brand-bold); font-weight: 500; padding: 0; text-align: left; width: auto; justify-content: flex-start; }
    .btn-add-row:hover { text-decoration: underline; }
    
    .btn-remove-row { color: var(--ds-text-subtle); background: transparent; width: 24px; height: 24px; padding: 0; font-size: 18px; line-height: 1; }
    .btn-remove-row:hover { color: var(--ds-background-danger-bold); }

    .license-summary-box { margin-top: 20px; padding: 16px; background: var(--ds-surface-sunken); border-radius: 3px; border: 1px solid var(--ds-border); }
    .license-summary-title { font-size: 12px; font-weight: 700; text-transform: uppercase; color: var(--ds-text-subtle); margin-bottom: 8px; }
    .license-summary-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 8px; }
    .license-tag { display: flex; justify-content: space-between; font-size: 13px; background: var(--ds-surface); color: var(--ds-text); padding: 4px 8px; border-radius: 3px; border: 1px solid var(--ds-border); }

    .global-comment-area { width: 100%; min-height: 120px; padding: 12px; border: 1px solid var(--ds-border); background: var(--ds-background-input); color: var(--ds-text); border-radius: 3px; font-family: inherit; font-size: 14px; line-height: 1.5; resize: vertical; }
    .global-comment-area:focus { background: var(--ds-surface); border-color: var(--ds-border-focused); outline: none; }

    /* --- Sidebar --- */
    aside { position: sticky; top: 110px; }
    .summary-panel { background: var(--ds-surface); border-radius: 3px; box-shadow: var(--ds-shadow-card); overflow: hidden; border: 1px solid transparent; }
    [data-theme="dark"] .summary-panel { border: 1px solid var(--ds-border); }

    .summary-header { padding: 16px 20px; background: var(--ds-surface-sunken); border-bottom: 1px solid var(--ds-border); }
    .summary-header h2 { margin: 0; font-size: 14px; font-weight: 700; text-transform: uppercase; color: var(--ds-text-subtle); }
    .summary-body { padding: 24px 20px; }
    
    .summary-row { display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 12px; font-size: 14px; color: var(--ds-text); }
    .summary-row.total { margin-top: 16px; padding-top: 16px; border-top: 2px solid var(--ds-border); }
    .summary-label { color: var(--ds-text-subtle); }
    .summary-value { font-weight: 600; color: var(--ds-text); }
    .cost-total { font-size: 20px; color: var(--ds-background-brand-bold); font-weight: 700; }

    .actions { padding: 16px 20px; background: var(--ds-surface-sunken); border-top: 1px solid var(--ds-border); display: flex; flex-direction: column; gap: 8px; }
    button { display: inline-flex; align-items: center; justify-content: center; height: 32px; padding: 0 12px; border-radius: 3px; border: none; font-weight: 500; font-size: 14px; cursor: pointer; transition: background 0.1s; width: 100%; }
    
    button.primary { background: var(--ds-background-brand-bold); color: #FFFFFF; }
    button.primary:hover { background: var(--ds-background-brand-bold-hovered); color: #FFFFFF; }

    button.secondary { background: rgba(9, 30, 66, 0.04); color: var(--ds-text); }
    [data-theme="dark"] button.secondary { background: rgba(255, 255, 255, 0.05); }
    button.secondary:hover { background: rgba(9, 30, 66, 0.08); }
    [data-theme="dark"] button.secondary:hover { background: rgba(255, 255, 255, 0.1); }

    button.ghost { background: transparent; color: var(--ds-text-subtle); }
    button.ghost:hover { color: var(--ds-background-danger-bold); }

    input.hours-input { width: 80px; text-align: right; padding: 6px 8px; border: 1px solid transparent; background: var(--ds-background-input); color: var(--ds-text); border-radius: 3px; }
    input.hours-input:focus { background: var(--ds-surface); border-color: var(--ds-border-focused); outline: none; }
    .estimation-row { display: flex; justify-content: space-between; align-items: center; padding-top: 20px; border-top: 1px solid var(--ds-border); }
    
    /* Toggle */
    .switch { position: relative; display: inline-block; width: 32px; height: 16px; }
    .switch input { opacity: 0; width: 0; height: 0; }
    .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #6B778C; transition: .2s; border-radius: 16px; }
    .slider:before { position: absolute; content: ""; height: 12px; width: 12px; left: 2px; bottom: 2px; background-color: white; transition: .2s; border-radius: 50%; }
    input:checked + .slider { background-color: var(--ds-background-success-bold); }
    input:checked + .slider:before { transform: translateX(16px); }
    
    #file-input { display: none; }

    /* Print Styles */
    @media print {
      body { background: white; color: black; padding: 0; }
      [data-theme="dark"] { --ds-text: black; --ds-text-subtle: #666; --ds-border: #ccc; } 
      
      header { position: static; box-shadow: none; border-bottom: 2px solid #000; background: white; }
      .header-actions { display: none; } /* Hide buttons on print */
      
      .client-input-group label { display: block; color: #000; }
      .client-name-input { border: none; padding: 0; text-align: right; font-weight: bold; width: auto; color: #000; }
      
      .app-container { display: block; padding: 0; margin: 20px 0; }
      aside { display: none; }
      
      .section-card { box-shadow: none; border: 1px solid #ccc; margin-bottom: 20px; page-break-inside: avoid; background: white; }
      .section-disabled, .task-item.excluded { display: none; }
      
      /* HIDE SECTION NUMBERS (BADGES) ON PRINT */
      .section-badge { display: none !important; }
      .section-header { justify-content: flex-start; }
      .section-title { margin-left: 0; font-size: 14px; text-transform: uppercase; }

      input, select, textarea { border: none; background: transparent; resize: none; appearance: none; padding: 0; color: black; }
      
      .btn-add-row, .btn-remove-row { display: none; }
      .global-comment-area { border: none; padding: 0; background: transparent; height: auto; min-height: auto; }
      
      .no-print { display: none !important; }

      .app-container::after {
        content: "Hours: " attr(data-print-hours) " | Services: " attr(data-print-services) " | Licenses: " attr(data-print-licenses) " | TOTAL: " attr(data-print-total);
        display: block; margin-top: 40px; padding-top: 20px; border-top: 2px solid #000; font-weight: bold; font-size: 16px; text-align: right;
      }
    }
  </style>
</head>
<body>

<header>
  <div class="header-content">
    <div class="header-left-group">
      <img src="https://images.seeklogo.com/logo-png/32/1/atlassian-logo-png_seeklogo-326273.png" alt="Atlassian Logo" class="atlassian-logo">
      <div class="header-titles">
        <h1>Implementation Estimation</h1>
        <p style="margin: 4px 0 0; font-size: 14px; color: var(--ds-text-subtle);">Scope & License Planner</p>
      </div>
    </div>
    
    <div class="header-actions">
      <div class="client-input-group">
        <label for="client-name">Customer</label>
        <input type="text" id="client-name" class="client-name-input" placeholder="Enter customer name...">
      </div>
      
      <button class="theme-toggle-btn" onclick="toggleTheme()" title="Toggle Dark/Light Mode">
        <span id="theme-icon">☀</span>
      </button>
    </div>
  </div>
</header>

<div class="app-container" id="main-container">
  <main>
    <form id="calc-form" class="sections-wrapper">

      <div class="phase-header no-print">
        <span class="phase-badge">A</span>
        <span>Administrative and Contractual Onboarding</span>
      </div>

      <div class="section-card billable-section" id="sec-1">
        <div class="section-header">
          <div class="header-left"><span class="section-badge">1</span><span class="section-title">Initial Communication and Kick-off</span></div>
          <label class="switch"><input type="checkbox" class="section-toggle" checked data-target="sec-1"><span class="slider"></span></label>
        </div>
        <div class="section-body">
          <ul class="tasks-list">
            <li class="task-item"><input type="checkbox" checked><span>Kick-off call or meeting</span></li>
            <li class="task-item"><input type="checkbox" checked><span>Overview of the support and service model</span></li>
            <li class="task-item"><input type="checkbox" checked><span>Identification of key stakeholders from both sides</span></li>
            <li class="task-item"><input type="checkbox" checked><span>Clarification of goals and expectations</span></li>
            <li class="task-item"><input type="checkbox" checked><span>Alignment on the implementation timeline</span></li>
          </ul>
          <div class="estimation-row"><label>Estimated Hours</label><input type="number" class="hours-input" value="1.0" step="0.5" min="0"></div>
        </div>
      </div>

      <div class="section-card billable-section" id="sec-2">
        <div class="section-header">
          <div class="header-left"><span class="section-badge">2</span><span class="section-title">Contractual, Legal, and Commercial Matters</span></div>
          <label class="switch"><input type="checkbox" class="section-toggle" checked data-target="sec-2"><span class="slider"></span></label>
        </div>
        <div class="section-body">
          <ul class="tasks-list">
            <li class="task-item"><input type="checkbox" checked><span>Signing of contract / SOW</span></li>
            <li class="task-item"><input type="checkbox" checked><span>NDA (if required)</span></li>
            <li class="task-item"><input type="checkbox" checked><span>SLA definition (support levels, response/resolution times)</span></li>
            <li class="task-item"><input type="checkbox" checked><span>Agreement on pricing / billing terms</span></li>
            <li class="task-item"><input type="checkbox" checked><span>Providing billing and invoicing contacts</span></li>
            <li class="task-item"><input type="checkbox" checked><span>Defining the billing cycle</span></li>
          </ul>
          <div class="estimation-row"><label>Estimated Hours</label><input type="number" class="hours-input" value="1.0" step="0.5" min="0"></div>
        </div>
      </div>

      <div class="section-card billable-section" id="sec-3">
        <div class="section-header">
          <div class="header-left"><span class="section-badge">3</span><span class="section-title">Collection of Initial Customer Information</span></div>
          <label class="switch"><input type="checkbox" class="section-toggle" checked data-target="sec-3"><span class="slider"></span></label>
        </div>
        <div class="section-body">
          <ul class="tasks-list">
            <li class="task-item"><input type="checkbox" checked><span>Completion of the Atlassian Onboarding Form</span></li>
            <li class="task-item"><input type="checkbox" checked><span>Collecting contacts of key users and stakeholders</span></li>
            <li class="task-item"><input type="checkbox" checked><span>Gathering information about existing processes and systems</span></li>
            <li class="task-item"><input type="checkbox" checked><span>Exchanging internal policies / SOPs / flow diagrams</span></li>
            <li class="task-item"><input type="checkbox" checked><span>Collecting details about integrations, environments, and tools</span></li>
          </ul>
          <div class="estimation-row"><label>Estimated Hours</label><input type="number" class="hours-input" value="2.0" step="0.5" min="0"></div>
        </div>
      </div>

      <div class="phase-header no-print">
        <span class="phase-badge">B</span>
        <span>Technical Onboarding (Atlassian)</span>
      </div>

      <div class="section-card billable-section" id="sec-4">
        <div class="section-header">
          <div class="header-left"><span class="section-badge">4</span><span class="section-title">High-level Solution Design</span></div>
          <label class="switch"><input type="checkbox" class="section-toggle" checked data-target="sec-4"><span class="slider"></span></label>
        </div>
        <div class="section-body">
          <ul class="tasks-list">
            <li class="task-item"><input type="checkbox" checked><span>Selection of project types (JSM / JSW)</span></li>
            <li class="task-item"><input type="checkbox" checked><span>Designing the access model (groups, roles, customers)</span></li>
            <li class="task-item"><input type="checkbox" checked><span>Defining SLA logic</span></li>
            <li class="task-item"><input type="checkbox" checked><span>Designing the Assets/CMDB structure (if in scope)</span></li>
            <li class="task-item"><input type="checkbox" checked><span>Selecting required integrations and communication channels</span></li>
            <li class="task-item"><input type="checkbox" checked><span>Choosing documentation structure (Confluence)</span></li>
          </ul>
          <div class="estimation-row"><label>Estimated Hours</label><input type="number" class="hours-input" value="3.0" step="0.5" min="0"></div>
        </div>
      </div>

      <div class="section-card billable-section" id="sec-5">
        <div class="section-header">
          <div class="header-left"><span class="section-badge">5</span><span class="section-title">Jira Service Management Setup</span></div>
          <label class="switch"><input type="checkbox" class="section-toggle" checked data-target="sec-5"><span class="slider"></span></label>
        </div>
        <div class="section-body">
          <ul class="tasks-list">
            <li class="task-item"><input type="checkbox" checked><span>Creating the JSM project</span></li>
            <li class="task-item"><input type="checkbox" checked><span>Configuring issue types</span></li>
            <li class="task-item"><input type="checkbox" checked><span>Setting up request types, forms, and fields</span></li>
            <li class="task-item"><input type="checkbox" checked><span>Designing portal structure and grouping categories</span></li>
            <li class="task-item"><input type="checkbox" checked><span>Configuring SLAs (response/resolution)</span></li>
            <li class="task-item"><input type="checkbox" checked><span>Setting working calendars</span></li>
            <li class="task-item"><input type="checkbox" checked><span>Creating queues (triage, priority, incident, escalation)</span></li>
            <li class="task-item"><input type="checkbox" checked><span>Workflow configuration (statuses, transitions, resolutions)</span></li>
            <li class="task-item"><input type="checkbox" checked><span>Automation setup (assignment, triage, auto-close, notifications)</span></li>
          </ul>
          <div class="estimation-row"><label>Estimated Hours</label><input type="number" class="hours-input" value="5.0" step="0.5" min="0"></div>
        </div>
      </div>

      <div class="section-card billable-section" id="sec-6">
        <div class="section-header">
          <div class="header-left"><span class="section-badge">6</span><span class="section-title">Jira Software Setup (optional)</span></div>
          <label class="switch"><input type="checkbox" class="section-toggle" checked data-target="sec-6"><span class="slider"></span></label>
        </div>
        <div class="section-body">
          <ul class="tasks-list">
            <li class="task-item"><input type="checkbox" checked><span>Creating the JSW project</span></li>
            <li class="task-item"><input type="checkbox" checked><span>Configuring issue types (Epic/Story/Bug/Task)</span></li>
            <li class="task-item"><input type="checkbox" checked><span>Aligning JSW workflows with JSM</span></li>
            <li class="task-item"><input type="checkbox" checked><span>Configuring Kanban/Scrum boards</span></li>
            <li class="task-item"><input type="checkbox" checked><span>Linking and automation between JSM → JSW</span></li>
          </ul>
          <div class="estimation-row"><label>Estimated Hours</label><input type="number" class="hours-input" value="3.0" step="0.5" min="0"></div>
        </div>
      </div>

      <div class="section-card billable-section" id="sec-7">
        <div class="section-header">
          <div class="header-left"><span class="section-badge">7</span><span class="section-title">Access, Authentication, and User Management</span></div>
          <label class="switch"><input type="checkbox" class="section-toggle" checked data-target="sec-7"><span class="slider"></span></label>
        </div>
        <div class="section-body">
          <ul class="tasks-list">
            <li class="task-item"><input type="checkbox" checked><span>Creating/updating Atlassian groups (Agents, Users)</span></li>
            <li class="task-item"><input type="checkbox" checked><span>Assigning product access</span></li>
            <li class="task-item"><input type="checkbox" checked><span>Adding users (full name + email)</span></li>
            <li class="task-item"><input type="checkbox" checked><span>Assigning Jira project roles</span></li>
            <li class="task-item"><input type="checkbox" checked><span>Applying authentication policies (SSO/MFA/Guard Policy)</span></li>
            <li class="task-item"><input type="checkbox" checked><span>Setting up portal-only customers</span></li>
            <li class="task-item"><input type="checkbox" checked><span>Access validation and permission testing</span></li>
          </ul>
          <div class="estimation-row"><label>Estimated Hours</label><input type="number" class="hours-input" value="2.5" step="0.5" min="0"></div>
        </div>
      </div>

      <div class="section-card billable-section" id="sec-8">
        <div class="section-header">
          <div class="header-left"><span class="section-badge">8</span><span class="section-title">Confluence Setup</span></div>
          <label class="switch"><input type="checkbox" class="section-toggle" checked data-target="sec-8"><span class="slider"></span></label>
        </div>
        <div class="section-body">
          <ul class="tasks-list">
            <li class="task-item"><input type="checkbox" checked><span>Creating a new space</span></li>
            <li class="task-item"><input type="checkbox" checked><span>Configuring access permissions (internal / customer)</span></li>
            <li class="task-item"><input type="checkbox" checked><span>Linking JSM → Confluence as a Knowledge Base</span></li>
            <li class="task-item"><input type="checkbox" checked><span>Creating base documentation pages</span></li>
            <li class="task-item"><input type="checkbox" checked><span>Preparing reusable documentation templates</span></li>
          </ul>
          <div class="estimation-row"><label>Estimated Hours</label><input type="number" class="hours-input" value="2.0" step="0.5" min="0"></div>
        </div>
      </div>

      <div class="section-card billable-section" id="sec-9">
        <div class="section-header">
          <div class="header-left"><span class="section-badge">9</span><span class="section-title">Assets / CMDB Setup (optional)</span></div>
          <label class="switch"><input type="checkbox" class="section-toggle" checked data-target="sec-9"><span class="slider"></span></label>
        </div>
        <div class="section-body">
          <ul class="tasks-list">
            <li class="task-item"><input type="checkbox" checked><span>Designing the object schema</span></li>
            <li class="task-item"><input type="checkbox" checked><span>Creating object types, attributes and relationships</span></li>
            <li class="task-item"><input type="checkbox" checked><span>Importing objects (manual or CSV)</span></li>
            <li class="task-item"><input type="checkbox" checked><span>Adding Assets fields to JSM request forms</span></li>
            <li class="task-item"><input type="checkbox" checked><span>Testing object lookup in the portal and agent view</span></li>
          </ul>
          <div class="estimation-row"><label>Estimated Hours</label><input type="number" class="hours-input" value="4.0" step="0.5" min="0"></div>
        </div>
      </div>

      <div class="section-card billable-section" id="sec-10">
        <div class="section-header">
          <div class="header-left"><span class="section-badge">10</span><span class="section-title">Integrations</span></div>
          <label class="switch"><input type="checkbox" class="section-toggle" checked data-target="sec-10"><span class="slider"></span></label>
        </div>
        <div class="section-body">
          <ul class="tasks-list">
            <li class="task-item"><input type="checkbox" checked><span>Configuring the email channel (incoming/outgoing)</span></li>
            <li class="task-item"><input type="checkbox" checked><span>Slack or Microsoft Teams integration</span></li>
            <li class="task-item"><input type="checkbox" checked><span>Using built-in Ops integration (for Premium/Enterprise)</span></li>
            <li class="task-item"><input type="checkbox" checked><span>Setting up webhook triggers or API integrations</span></li>
            <li class="task-item"><input type="checkbox" checked><span>Full testing of all integrations</span></li>
          </ul>
          <div class="estimation-row"><label>Estimated Hours</label><input type="number" class="hours-input" value="3.0" step="0.5" min="0"></div>
        </div>
      </div>

      <div class="phase-header no-print">
        <span class="phase-badge">C</span>
        <span>Operational Onboarding</span>
      </div>

      <div class="section-card billable-section" id="sec-11">
        <div class="section-header">
          <div class="header-left"><span class="section-badge">11</span><span class="section-title">Testing & UAT</span></div>
          <label class="switch"><input type="checkbox" class="section-toggle" checked data-target="sec-11"><span class="slider"></span></label>
        </div>
        <div class="section-body">
          <ul class="tasks-list">
            <li class="task-item"><input type="checkbox" checked><span>End-to-end testing of all core flows</span></li>
            <li class="task-item"><input type="checkbox" checked><span>SLA, Automation and Portal testing</span></li>
            <li class="task-item"><input type="checkbox" checked><span>Integration testing</span></li>
            <li class="task-item"><input type="checkbox" checked><span>Logging and resolving issues discovered during UAT</span></li>
          </ul>
          <div class="estimation-row"><label>Estimated Hours</label><input type="number" class="hours-input" value="4.0" step="0.5" min="0"></div>
        </div>
      </div>

      <div class="section-card billable-section" id="sec-12">
        <div class="section-header">
          <div class="header-left"><span class="section-badge">12</span><span class="section-title">Go-live</span></div>
          <label class="switch"><input type="checkbox" class="section-toggle" checked data-target="sec-12"><span class="slider"></span></label>
        </div>
        <div class="section-body">
          <ul class="tasks-list">
            <li class="task-item"><input type="checkbox" checked><span>Enabling final production configurations</span></li>
            <li class="task-item"><input type="checkbox" checked><span>Real-world access validation with the customer</span></li>
            <li class="task-item"><input type="checkbox" checked><span>Final check of all roles, rules, notifications</span></li>
          </ul>
          <div class="estimation-row"><label>Estimated Hours</label><input type="number" class="hours-input" value="1.0" step="0.5" min="0"></div>
        </div>
      </div>

      <div class="section-card billable-section" id="sec-13">
        <div class="section-header">
          <div class="header-left"><span class="section-badge">13</span><span class="section-title">Handover</span></div>
          <label class="switch"><input type="checkbox" class="section-toggle" checked data-target="sec-13"><span class="slider"></span></label>
        </div>
        <div class="section-body">
          <ul class="tasks-list">
            <li class="task-item"><input type="checkbox" checked><span>Providing the admin guide and user guides</span></li>
            <li class="task-item"><input type="checkbox" checked><span>Customer team training</span></li>
            <li class="task-item"><input type="checkbox" checked><span>Demonstration of queues, SLAs, and Knowledge Base</span></li>
            <li class="task-item"><input type="checkbox" checked><span>Explanation of the operational model</span></li>
          </ul>
          <div class="estimation-row"><label>Estimated Hours</label><input type="number" class="hours-input" value="2.0" step="0.5" min="0"></div>
        </div>
      </div>

      <div class="section-card billable-section" id="sec-14">
        <div class="section-header">
          <div class="header-left"><span class="section-badge">14</span><span class="section-title">Hypercare</span></div>
          <label class="switch"><input type="checkbox" class="section-toggle" checked data-target="sec-14"><span class="slider"></span></label>
        </div>
        <div class="section-body">
          <ul class="tasks-list">
            <li class="task-item"><input type="checkbox" checked><span>Defining the hypercare period and communication channels</span></li>
            <li class="task-item"><input type="checkbox" checked><span>Responsible contacts on both sides</span></li>
            <li class="task-item"><input type="checkbox" checked><span>Reactive and proactive support after go-live</span></li>
          </ul>
          <div class="estimation-row"><label>Estimated Hours</label><input type="number" class="hours-input" value="2.0" step="0.5" min="0"></div>
        </div>
      </div>

      <div class="phase-header no-print">
        <span class="phase-badge">D</span>
        <span>Post-Onboarding</span>
      </div>

      <div class="section-card billable-section" id="sec-15">
        <div class="section-header">
          <div class="header-left"><span class="section-badge">15</span><span class="section-title">Post-onboarding Review</span></div>
          <label class="switch"><input type="checkbox" class="section-toggle" checked data-target="sec-15"><span class="slider"></span></label>
        </div>
        <div class="section-body">
          <ul class="tasks-list">
            <li class="task-item"><input type="checkbox" checked><span>Customer satisfaction check</span></li>
            <li class="task-item"><input type="checkbox" checked><span>First 30-day performance review</span></li>
            <li class="task-item"><input type="checkbox" checked><span>SLA performance analysis</span></li>
            <li class="task-item"><input type="checkbox" checked><span>Identifying improvement opportunities & next phase</span></li>
          </ul>
          <div class="estimation-row"><label>Estimated Hours</label><input type="number" class="hours-input" value="1.0" step="0.5" min="0"></div>
        </div>
      </div>

      <div class="section-card" id="sec-license">
        <div class="section-header" style="background-color: var(--ds-surface-sunken); border-bottom: 2px solid var(--ds-border-focused);">
          <div class="header-left"><span class="section-title" style="color: var(--ds-link);">License Planning</span></div>
          <label class="switch"><input type="checkbox" class="section-toggle" checked data-target="sec-license"><span class="slider"></span></label>
        </div>
        <div class="section-body">
          <table class="license-table">
            <thead>
              <tr>
                <th style="width: 25%;">Product</th>
                <th style="width: 20%;">Team Name</th>
                <th style="width: 20%;">Comment</th>
                <th style="width: 10%;">Count</th>
                <th style="width: 15%;">Price ($)</th>
                <th style="width: 10%; text-align:right;">Total</th>
                <th style="width: 5%;"></th>
              </tr>
            </thead>
            <tbody id="license-rows"></tbody>
          </table>
          <button type="button" class="btn-add-row" onclick="addLicenseRow()">+ Add Team</button>
          
          <div class="license-summary-box">
            <div class="license-summary-title">License Seat Summary</div>
            <div class="license-summary-grid" id="license-seat-summary"></div>
            <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--ds-border);">
                <div class="license-summary-title">License Cost Summary</div>
                <div class="license-summary-grid" id="license-cost-summary"></div>
            </div>
          </div>
        </div>
      </div>

      <div class="section-card" id="sec-comments">
        <div class="section-header">
          <div class="header-left"><span class="section-title">Scope Assumptions & Comments</span></div>
          <label class="switch"><input type="checkbox" class="section-toggle" checked data-target="sec-comments"><span class="slider"></span></label>
        </div>
        <div class="section-body">
          <textarea id="global-comment" class="global-comment-area" placeholder="Add any scope exclusions, prerequisites, or specific notes for the customer..."></textarea>
        </div>
      </div>

    </form>
  </main>

  <aside>
    <div class="summary-panel">
      <div class="summary-header">
        <h2>Estimation Summary</h2>
      </div>
      
      <div class="summary-body">
        
        <div class="summary-row" style="margin-bottom: 20px;">
          <span class="summary-label">Include Services Cost</span>
          <label class="switch" style="transform: scale(0.9);">
            <input type="checkbox" id="toggle-services-cost" checked onchange="toggleServicesCost()">
            <span class="slider"></span>
          </label>
        </div>

        <div class="summary-row">
            <span class="summary-label">Total Hours</span>
            <span class="summary-value" id="total-hours">0.0 h</span>
        </div>
        
        <div id="service-cost-group">
            <div class="summary-row" style="margin-bottom:12px; align-items: center;">
              <span class="summary-label" style="font-size:12px;">Hourly Rate</span>
              <input type="number" id="hourly-rate" value="100" style="width: 70px; text-align:right; border:1px solid var(--ds-border); background: var(--ds-background-input); color: var(--ds-text); border-radius:3px; padding:2px 4px; font-size:12px;">
            </div>
            <div class="summary-row" style="border-bottom: 1px solid var(--ds-border); padding-bottom:12px; margin-bottom:16px;">
              <span class="summary-label">Services Cost</span>
              <span class="summary-value cost-main" id="service-cost">$0</span>
            </div>
        </div>

        <div class="summary-row" style="margin-bottom:16px;">
          <span class="summary-label">License Cost</span>
          <span class="summary-value cost-main" id="license-cost">$0</span>
        </div>

        <div class="summary-row total">
          <span class="summary-label" style="font-weight:700;">Grand Total</span>
          <span class="summary-value cost-total" id="grand-total">$0</span>
        </div>

      </div>

      <div class="actions">
        <button class="primary" onclick="window.print()">Export to PDF</button>
        <a href="https://www.atlassian.com/software/pricing-calculator" target="_blank" style="text-decoration: none; width: 100%;">
            <button class="secondary" type="button">Atlassian Pricing Calculator ↗</button>
        </a>
        <div style="height: 1px; background: var(--ds-border); margin: 4px 0;"></div>
        <button class="secondary" onclick="exportData()">Export JSON</button>
        <button class="secondary" onclick="document.getElementById('file-input').click()">Import JSON</button>
        <button class="ghost" onclick="resetDefaults()">Reset to Defaults</button>
        <input type="file" id="file-input" accept=".json" onchange="importData(event)">
      </div>
    </div>
  </aside>

</div>

<script>
  const STORAGE_KEY = 'atlassian_estimate_final_v12_png';
  
  const PRODUCTS = [
    "Jira Software",
    "Jira Service Management",
    "Jira Product Discovery",
    "Confluence",
    "Bitbucket",
    "Compass",
    "Atlassian Guard"
  ];

  const currencyFormatter = new Intl.NumberFormat('en-US', {
      style: 'currency', currency: 'USD', minimumFractionDigits: 0, maximumFractionDigits: 0,
  });

  // --- Theme Logic ---
  function toggleTheme() {
    const html = document.documentElement;
    const current = html.getAttribute('data-theme');
    const next = current === 'dark' ? 'light' : 'dark';
    html.setAttribute('data-theme', next);
    document.getElementById('theme-icon').textContent = next === 'dark' ? '☾' : '☀';
    localStorage.setItem('theme_preference', next);
  }

  function loadTheme() {
    const saved = localStorage.getItem('theme_preference') || 'light';
    document.documentElement.setAttribute('data-theme', saved);
    document.getElementById('theme-icon').textContent = saved === 'dark' ? '☾' : '☀';
  }

  // --- Main Init ---
  document.addEventListener('DOMContentLoaded', () => {
    loadTheme();

    document.getElementById('calc-form').addEventListener('change', (e) => {
        if (e.target.matches('.section-toggle')) handleSectionToggle(e);
        if (e.target.matches('.task-item input[type="checkbox"]')) handleTaskToggle(e);
        if (e.target.matches('.license-input') || e.target.matches('.license-select')) updateLicenseRow(e.target);
        recalculate();
    });

    document.getElementById('calc-form').addEventListener('input', (e) => {
        if (e.target.matches('.hours-input')) recalculate();
        if (e.target.id === 'client-name' || e.target.id === 'global-comment') saveState();
        if (e.target.closest('#license-rows')) updateLicenseRow(e.target);
    });

    document.getElementById('hourly-rate').addEventListener('input', recalculate);

    const saved = localStorage.getItem(STORAGE_KEY);
    if (saved) {
        try { restoreState(JSON.parse(saved)); } catch(e) { console.error(e); }
    } else {
        addLicenseRow();
        recalculate();
    }
    toggleServicesCostLogic();
  });

  function toggleServicesCost() {
      toggleServicesCostLogic();
      recalculate();
  }

  function toggleServicesCostLogic() {
      const isChecked = document.getElementById('toggle-services-cost').checked;
      const group = document.getElementById('service-cost-group');
      group.style.display = isChecked ? 'block' : 'none';
  }

  function handleSectionToggle(e) {
    const sectionId = e.target.getAttribute('data-target');
    const card = document.getElementById(sectionId);
    if (e.target.checked) {
      card.classList.remove('section-disabled');
      card.querySelector('.section-body').classList.remove('section-body-disabled');
    } else {
      card.classList.add('section-disabled');
      card.querySelector('.section-body').classList.add('section-body-disabled');
    }
    recalculate(); 
  }

  function handleTaskToggle(e) {
    const li = e.target.closest('.task-item');
    if (e.target.checked) li.classList.remove('excluded');
    else li.classList.add('excluded');
  }

  function recalculate() {
    let totalHours = 0;
    // Sum only billable sections 1-15
    document.querySelectorAll('.billable-section').forEach(card => {
      const toggle = card.querySelector('.section-toggle');
      if (toggle && toggle.checked) {
        const input = card.querySelector('.hours-input');
        if(input) {
            const val = parseFloat(input.value);
            if (!isNaN(val) && val >= 0) totalHours += val;
        }
      }
    });

    let totalLicenseCost = 0;
    const licenseSection = document.getElementById('sec-license');
    if (licenseSection && licenseSection.querySelector('.section-toggle').checked) {
        document.querySelectorAll('#license-rows tr').forEach(tr => {
            const count = parseInt(tr.querySelector('.count-input').value) || 0;
            const price = parseFloat(tr.querySelector('.price-input').value) || 0;
            totalLicenseCost += (count * price);
        });
    }

    const rate = parseFloat(document.getElementById('hourly-rate').value) || 0;
    const includeServiceCost = document.getElementById('toggle-services-cost').checked;
    
    let serviceCost = 0;
    if (includeServiceCost) {
        serviceCost = totalHours * rate;
    }

    const grandTotal = serviceCost + totalLicenseCost;

    const totalHoursStr = totalHours.toFixed(1) + ' h';
    document.getElementById('total-hours').textContent = totalHoursStr;
    document.getElementById('service-cost').textContent = currencyFormatter.format(serviceCost);
    document.getElementById('license-cost').textContent = currencyFormatter.format(totalLicenseCost);
    document.getElementById('grand-total').textContent = currencyFormatter.format(grandTotal);

    const container = document.getElementById('main-container');
    container.setAttribute('data-print-hours', totalHoursStr);
    container.setAttribute('data-print-services', includeServiceCost ? currencyFormatter.format(serviceCost) : 'Excluded');
    container.setAttribute('data-print-licenses', currencyFormatter.format(totalLicenseCost));
    container.setAttribute('data-print-total', currencyFormatter.format(grandTotal));
    
    updateLicenseSummaryBox();
    saveState();
  }

  function addLicenseRow(data = null) {
    const tbody = document.getElementById('license-rows');
    const tr = document.createElement('tr');
    
    let options = PRODUCTS.map(p => `<option value="${p}">${p}</option>`).join('');
    
    tr.innerHTML = `
      <td><select class="license-select product-select">${options}</select></td>
      <td><input type="text" class="license-input team-input" placeholder="e.g. DevOps"></td>
      <td><input type="text" class="license-input comment-input" placeholder="Details"></td>
      <td><input type="number" class="license-input count-input" value="0" min="0"></td>
      <td><input type="number" class="license-input price-input" value="0" min="0" step="0.01"></td>
      <td class="row-total-cell">$0</td>
      <td style="text-align:center;">
        <button type="button" class="btn-remove-row" onclick="removeLicenseRow(this)">×</button>
      </td>
    `;

    tbody.appendChild(tr);

    if (data) {
        tr.querySelector('.product-select').value = data.product;
        tr.querySelector('.team-input').value = data.team;
        tr.querySelector('.comment-input').value = data.comment;
        tr.querySelector('.count-input').value = data.count;
        tr.querySelector('.price-input').value = data.price || 0;
        calculateRowTotal(tr);
    }
  }

  function updateLicenseRow(input) {
      const tr = input.closest('tr');
      if(tr) calculateRowTotal(tr);
      recalculate();
  }

  function calculateRowTotal(tr) {
      const count = parseInt(tr.querySelector('.count-input').value) || 0;
      const price = parseFloat(tr.querySelector('.price-input').value) || 0;
      const total = count * price;
      tr.querySelector('.row-total-cell').textContent = currencyFormatter.format(total);
  }

  function removeLicenseRow(btn) {
    btn.closest('tr').remove();
    recalculate();
  }

  function updateLicenseSummaryBox() {
    const seatSummary = {};
    const costSummary = {};
    const rows = document.querySelectorAll('#license-rows tr');
    const isEnabled = document.getElementById('sec-license').querySelector('.section-toggle').checked;
    
    const seatContainer = document.getElementById('license-seat-summary');
    const costContainer = document.getElementById('license-cost-summary');

    if(!isEnabled) {
        seatContainer.innerHTML = '<span style="color:var(--ds-text-subtle); font-size:13px;">Section excluded</span>';
        costContainer.innerHTML = '';
        return;
    }

    rows.forEach(tr => {
        const prod = tr.querySelector('.product-select').value;
        const count = parseInt(tr.querySelector('.count-input').value) || 0;
        const price = parseFloat(tr.querySelector('.price-input').value) || 0;
        const total = count * price;

        if(count > 0) {
            seatSummary[prod] = (seatSummary[prod] || 0) + count;
            costSummary[prod] = (costSummary[prod] || 0) + total;
        }
    });

    // Render Seats
    seatContainer.innerHTML = '';
    if (Object.keys(seatSummary).length === 0) {
        seatContainer.innerHTML = '<span style="color:var(--ds-text-subtle); font-size:13px;">No licenses added yet.</span>';
    } else {
        Object.keys(seatSummary).forEach(prod => {
            const div = document.createElement('div');
            div.className = 'license-tag';
            div.innerHTML = `<span>${prod}</span> <strong>${seatSummary[prod]}</strong>`;
            seatContainer.appendChild(div);
        });
    }

    // Render Costs
    costContainer.innerHTML = '';
    if (Object.keys(costSummary).length > 0) {
        Object.keys(costSummary).forEach(prod => {
            const div = document.createElement('div');
            div.className = 'license-tag';
            div.innerHTML = `<span>${prod}</span> <strong>${currencyFormatter.format(costSummary[prod])}</strong>`;
            costContainer.appendChild(div);
        });
    }
  }

  function gatherState() {
    const state = {
      clientName: document.getElementById('client-name').value,
      rate: document.getElementById('hourly-rate').value,
      includeServiceCost: document.getElementById('toggle-services-cost').checked,
      comments: document.getElementById('global-comment').value,
      sections: {},
      licenses: []
    };

    document.querySelectorAll('.section-card').forEach(card => {
      const id = card.id;
      const secToggle = card.querySelector('.section-toggle');
      const hoursInput = card.querySelector('.hours-input');
      const taskStates = [];
      card.querySelectorAll('.task-item input[type="checkbox"]').forEach(cb => {
        taskStates.push(cb.checked);
      });
      state.sections[id] = {
        active: secToggle.checked,
        hours: hoursInput ? hoursInput.value : 0,
        tasks: taskStates
      };
    });

    document.querySelectorAll('#license-rows tr').forEach(tr => {
        state.licenses.push({
            product: tr.querySelector('.product-select').value,
            team: tr.querySelector('.team-input').value,
            comment: tr.querySelector('.comment-input').value,
            count: tr.querySelector('.count-input').value,
            price: tr.querySelector('.price-input').value
        });
    });

    return state;
  }

  function saveState() {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(gatherState()));
  }

  function restoreState(state) {
      if (!state) return;
      if (state.clientName) document.getElementById('client-name').value = state.clientName;
      if (state.rate) document.getElementById('hourly-rate').value = state.rate;
      if (state.comments) document.getElementById('global-comment').value = state.comments;
      
      if (state.includeServiceCost !== undefined) {
          document.getElementById('toggle-services-cost').checked = state.includeServiceCost;
          toggleServicesCostLogic();
      }

      if (state.sections) {
        Object.keys(state.sections).forEach(id => {
          const data = state.sections[id];
          const card = document.getElementById(id);
          if (!card) return;

          const secToggle = card.querySelector('.section-toggle');
          if (secToggle) secToggle.checked = data.active;
          
          if (!data.active) {
             card.classList.add('section-disabled');
             card.querySelector('.section-body').classList.add('section-body-disabled');
          } else {
             card.classList.remove('section-disabled');
             card.querySelector('.section-body').classList.remove('section-body-disabled');
          }

          const hoursInput = card.querySelector('.hours-input');
          if (hoursInput) hoursInput.value = data.hours;

          if (data.tasks) {
            const checkboxes = card.querySelectorAll('.task-item input[type="checkbox"]');
            checkboxes.forEach((cb, idx) => {
              if (data.tasks[idx] !== undefined) {
                cb.checked = data.tasks[idx];
                const li = cb.closest('.task-item');
                if (cb.checked) li.classList.remove('excluded');
                else li.classList.add('excluded');
              }
            });
          }
        });
      }

      const tbody = document.getElementById('license-rows');
      tbody.innerHTML = ''; 
      if (state.licenses && state.licenses.length > 0) {
          state.licenses.forEach(row => addLicenseRow(row));
      } else {
          addLicenseRow(); 
      }

      recalculate();
  }

  function exportData() {
    const state = gatherState();
    const blob = new Blob([JSON.stringify(state, null, 2)], {type: "application/json"});
    const url = URL.createObjectURL(blob);
    const client = state.clientName ? state.clientName.replace(/[^a-z0-9]/gi, '_').toLowerCase() : 'estimate';
    const dateStr = new Date().toISOString().split('T')[0];
    
    const a = document.createElement('a');
    a.href = url;
    a.download = `${client}_${dateStr}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }

  function importData(event) {
    const file = event.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = function(e) {
      try {
        restoreState(JSON.parse(e.target.result));
        saveState();
        alert('Estimate loaded successfully');
      } catch (err) { alert('Invalid JSON'); }
      event.target.value = '';
    };
    reader.readAsText(file);
  }

  function resetDefaults() {
    if(confirm('Reset all data?')) {
      localStorage.removeItem(STORAGE_KEY);
      location.reload();
    }
  }
</script>

</body>
</html>